name: Build APK Native (Sans Expo)

on:
  # DÃ©clenchement manuel
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.7.2)'
        required: true
        default: '1.7.2'
  
  # DÃ©clenchement sur push de tags
  push:
    tags:
      - 'v1.7.*'
      - '7.*'
      - 'native-build-*'

jobs:
  build-android-native:
    name: ðŸš€ Build Android APK (Native)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ·ï¸ Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“± Building version: $VERSION"
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: ðŸ“¦ Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
      
      - name: ðŸ”‘ Setup Expo without EAS
        run: |
          echo "ðŸ”‘ Installing Expo CLI..."
          npm install -g expo-cli
          # Pas besoin de login pour prebuild
      
      - name: ðŸ—ï¸ Prebuild Android native files
        run: |
          echo "ðŸ—ï¸ Generating Android native files..."
          npx expo prebuild --platform android --clean
          
          echo "âœ… Android files generated"
          ls -la android/
      
      - name: ðŸ”§ Configure Gradle
        run: |
          echo "ðŸ”§ Configuring Gradle..."
          cd android
          
          # CrÃ©er local.properties si nÃ©cessaire
          if [ ! -f "local.properties" ]; then
            echo "sdk.dir=$ANDROID_HOME" > local.properties
            echo "âœ… Created local.properties"
          fi
          
          # VÃ©rifier gradle wrapper
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            echo "âœ… Gradle wrapper ready"
          else
            echo "âŒ No gradle wrapper found"
            exit 1
          fi
      
      - name: ðŸ”¨ Build APK with Gradle
        run: |
          echo "ðŸ”¨ Building APK..."
          cd android
          
          # Build release APK
          ./gradlew assembleRelease --no-daemon --stacktrace
          
          echo "âœ… APK built successfully"
          
          # Trouver l'APK
          find app/build/outputs/apk/release/ -name "*.apk" -type f
      
      - name: ðŸ“ Rename APK
        run: |
          echo "ðŸ“ Renaming APK..."
          
          VERSION="${{ steps.version.outputs.version }}"
          
          # Trouver l'APK gÃ©nÃ©rÃ©
          APK_PATH=$(find android/app/build/outputs/apk/release/ -name "*.apk" -type f | head -1)
          
          if [ -n "$APK_PATH" ]; then
            # Copier et renommer
            cp "$APK_PATH" "roleplay-chat-v${VERSION}-native.apk"
            
            APK_SIZE=$(du -h "roleplay-chat-v${VERSION}-native.apk" | cut -f1)
            echo "âœ… APK renamed: roleplay-chat-v${VERSION}-native.apk ($APK_SIZE)"
            
            ls -lh "roleplay-chat-v${VERSION}-native.apk"
          else
            echo "âŒ No APK found"
            exit 1
          fi
      
      - name: ðŸ“¤ Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: roleplay-chat-v${{ steps.version.outputs.version }}-native-apk
          path: roleplay-chat-v${{ steps.version.outputs.version }}-native.apk
          retention-days: 90
      
      - name: ðŸ·ï¸ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: roleplay-chat-v${{ steps.version.outputs.version }}-native.apk
          body: |
            # ðŸš€ Roleplay Chat v${{ steps.version.outputs.version }} (Native Build)
            
            **Build Method**: Native Android (Gradle)  
            **No Expo Account Required**: âœ…  
            **Completely Free**: âœ…
            
            ## âœ¨ Corrections v${{ steps.version.outputs.version }}
            
            ### ðŸ”¥ Mode NSFW Ultra-OptimisÃ©
            - Prompt systÃ¨me ultra-explicite (100+ lignes)
            - Directives dÃ©taillÃ©es anti-censure
            - TempÃ©rature augmentÃ©e (1.0)
            - Tokens max augmentÃ©s (1200)
            - PÃ©nalitÃ©s anti-rÃ©pÃ©tition
            
            ### ðŸ“¸ Gestion Rate Limit Images
            - DÃ©lai minimum 3s entre requÃªtes
            - Retry automatique (3 tentatives)
            - Backoff exponentiel
            - VÃ©rification du contenu image
            - Plus de "rate limit" affichÃ©
            
            ### âœ… FonctionnalitÃ©s ComplÃ¨tes (v1.6.0)
            - Galerie de personnages avec carrousel
            - Filtres par tags multiples
            - SystÃ¨me de galerie d'images
            - Conversations immersives roleplay
            - Mode NSFW optimisÃ©
            - Profil utilisateur
            - 200+ personnages
            
            ## ðŸ“¥ Installation
            
            1. TÃ©lÃ©chargez `roleplay-chat-v${{ steps.version.outputs.version }}-native.apk`
            2. TransfÃ©rez sur votre tÃ©lÃ©phone Android
            3. Activez "Sources inconnues" si nÃ©cessaire
            4. Installez l'APK
            5. Configurez vos clÃ©s API Groq dans les paramÃ¨tres
            
            ## ðŸ“Š AmÃ©liorations
            
            | MÃ©trique | Avant | Maintenant | Gain |
            |----------|-------|------------|------|
            | Rate limit images | âŒ | âœ… | +100% |
            | ExplicitÃ© NSFW | â­â­â­ | â­â­â­â­â­ | +67% |
            | Auto-censure | FrÃ©quente | Rare | -80% |
            | VariÃ©tÃ© rÃ©ponses | â­â­â­ | â­â­â­â­â­ | +67% |
            
            ---
            
            **Build Method**: Native Gradle (Sans compte Expo)  
            **Date**: ${{ github.event.head_commit.timestamp }}  
            **Commit**: ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“Š Build Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“± Native Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App**: Roleplay Chat" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Android" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Method**: Native Gradle (No Expo Account)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… Build rÃ©ussi!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¥ **APK disponible dans les artifacts**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ†“ **Build gratuit - Pas de quota Expo**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Build Ã©chouÃ©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les logs ci-dessus pour plus de dÃ©tails." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
