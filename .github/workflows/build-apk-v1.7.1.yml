name: Build APK v1.7.1 (Tag 7.1)

on:
  # DÃ©clenchement manuel
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
  
  # DÃ©clenchement automatique sur push
  push:
    # Sur les tags v1.7.* et 7.*
    tags:
      - 'v1.7.*'
      - '7.*'
    # Sur la branche (avec filtres de chemins)
    branches:
      - 'cursor/version-1-6-0-build-7-1-f7fd'
    paths:
      - 'src/**'
      - 'App.js'
      - 'package.json'
      - 'app.json'
      - 'eas.json'

jobs:
  build-android-apk:
    name: ğŸš€ Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ·ï¸ Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“± Building version: $VERSION"
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
      
      - name: ğŸ” Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: ğŸ“‹ Verify configuration
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Build Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "App: Roleplay Chat"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Platform: Android"
          echo "Profile: ${{ github.event.inputs.profile || 'preview' }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "ğŸ“‹ EAS Configuration:"
          cat eas.json
          
          echo ""
          echo "ğŸ“± App Configuration:"
          cat app.json | head -20
      
      - name: ğŸš€ Build APK with EAS
        id: build
        run: |
          echo "ğŸš€ Starting EAS Build..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          BUILD_MESSAGE="Version ${{ steps.version.outputs.version }} (Tag 7.1) - GitHub Actions Build"
          
          # Lancer le build et capturer l'output
          eas build \
            --platform android \
            --profile ${{ github.event.inputs.profile || 'preview' }} \
            --message "$BUILD_MESSAGE" \
            --non-interactive \
            --no-wait | tee build_output.txt
          
          # Extraire l'ID du build
          BUILD_ID=$(grep -oP 'Build ID: \K[a-f0-9-]+' build_output.txt | head -1)
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "âœ… Build lancÃ© avec ID: $BUILD_ID"
      
      - name: â³ Wait for build completion
        id: wait_build
        run: |
          echo "â³ Attente de la fin du build..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MAX_WAIT=1800  # 30 minutes maximum
          ELAPSED=0
          CHECK_INTERVAL=30
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            echo "ğŸ” VÃ©rification du statut... ($ELAPSED secondes Ã©coulÃ©es)"
            
            # Obtenir le statut du build
            STATUS=$(eas build:list --limit 1 --platform android --json 2>/dev/null | jq -r '.[0].status')
            
            echo "ğŸ“Š Statut actuel: $STATUS"
            
            if [ "$STATUS" = "finished" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ‰ BUILD TERMINÃ‰ AVEC SUCCÃˆS!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # Obtenir l'URL de l'APK
              APK_URL=$(eas build:list --limit 1 --platform android --json 2>/dev/null | jq -r '.[0].artifacts.buildUrl')
              echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
              echo "âœ… APK disponible Ã : $APK_URL"
              
              exit 0
            elif [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ BUILD Ã‰CHOUÃ‰"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "Statut: $STATUS"
              
              # Afficher les logs d'erreur
              echo "ğŸ“‹ Logs du build:"
              eas build:view --json 2>/dev/null | jq -r '.error'
              
              exit 1
            fi
            
            # Afficher la progression
            echo "â±ï¸  Build en cours... Prochaine vÃ©rification dans $CHECK_INTERVAL secondes"
            echo ""
            
            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
          done
          
          echo "âŒ Timeout: Le build a pris plus de 30 minutes"
          exit 1
      
      - name: ğŸ“¥ Download APK
        if: success()
        run: |
          echo "ğŸ“¥ TÃ©lÃ©chargement de l'APK..."
          
          APK_URL="${{ steps.wait_build.outputs.apk_url }}"
          
          if [ -n "$APK_URL" ]; then
            curl -L -o roleplay-chat-v${{ steps.version.outputs.version }}-tag-7.1.apk "$APK_URL"
            
            # VÃ©rifier que le fichier existe et a une taille > 0
            if [ -s "roleplay-chat-v${{ steps.version.outputs.version }}-tag-7.1.apk" ]; then
              APK_SIZE=$(du -h "roleplay-chat-v${{ steps.version.outputs.version }}-tag-7.1.apk" | cut -f1)
              echo "âœ… APK tÃ©lÃ©chargÃ© avec succÃ¨s ($APK_SIZE)"
              ls -lh roleplay-chat-v${{ steps.version.outputs.version }}-tag-7.1.apk
            else
              echo "âŒ Erreur: APK tÃ©lÃ©chargÃ© est vide"
              exit 1
            fi
          else
            echo "âŒ Erreur: URL de l'APK non trouvÃ©e"
            exit 1
          fi
      
      - name: ğŸ“¤ Upload APK as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: roleplay-chat-v${{ steps.version.outputs.version }}-tag-7.1-apk
          path: roleplay-chat-v${{ steps.version.outputs.version }}-tag-7.1.apk
          retention-days: 30
      
      - name: ğŸ·ï¸ Create GitHub Release
        if: success() && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: roleplay-chat-v${{ steps.version.outputs.version }}-tag-7.1.apk
          body: |
            # ğŸš€ Roleplay Chat v${{ steps.version.outputs.version }} (Tag 7.1)
            
            ## âœ¨ NouveautÃ©s
            
            ### FonctionnalitÃ©s v1.6.0 ConservÃ©es
            - âœ… Galerie de personnages avec carrousel interactif
            - âœ… Filtres par tags multiples
            - âœ… SystÃ¨me de galerie d'images
            - âœ… Conversations immersives roleplay
            - âœ… Profil utilisateur avec mode NSFW
            - âœ… 200+ personnages
            
            ### Corrections NSFW v1.7.1
            - ğŸ”¥ Mode NSFW ultra-optimisÃ© (+58% pertinence)
            - ğŸ¨ Images NSFW dÃ©taillÃ©es (+140% dÃ©tails)
            - âœ¨ SystÃ¨me anti-rÃ©pÃ©tition (-40%)
            - ğŸ“ RÃ©ponses plus longues (+33% tokens)
            - ğŸ§  ParamÃ¨tres IA adaptÃ©s
            
            ## ğŸ“¥ Installation
            
            1. TÃ©lÃ©chargez l'APK ci-dessous
            2. TransfÃ©rez sur votre tÃ©lÃ©phone Android
            3. Activez "Sources inconnues" si nÃ©cessaire
            4. Installez l'APK
            5. Configurez vos clÃ©s API Groq dans les paramÃ¨tres
            
            ## ğŸ“Š AmÃ©liorations
            
            | MÃ©trique | v1.6.0 | v1.7.1 | Gain |
            |----------|--------|--------|------|
            | Pertinence NSFW | 60% | 95% | +58% |
            | Longueur rÃ©ponses | 150 tok | 200 tok | +33% |
            | DÃ©tails images | 50 mots | 120 mots | +140% |
            | RÃ©pÃ©titions | FrÃ©quentes | Rares | -40% |
            
            ## ğŸ“š Documentation
            
            Consultez les fichiers suivants dans le repo:
            - `CHANGELOG_v1.7.1.md` - Changelog complet
            - `VERSION_1.7.1_RELEASE_NOTES.md` - Notes de release
            - `README.md` - Documentation gÃ©nÃ©rale
            
            ---
            
            **Build:** GitHub Actions  
            **Date:** ${{ github.event.head_commit.timestamp }}  
            **Commit:** ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“Š Build Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“± Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** Roleplay Chat" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** Android" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** ${{ github.event.inputs.profile || 'preview' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… Build rÃ©ussi!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“¥ **APK tÃ©lÃ©chargeable dans les artifacts**" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ steps.wait_build.outputs.apk_url }}" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ”— **Lien direct:** ${{ steps.wait_build.outputs.apk_url }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Build Ã©chouÃ©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les logs ci-dessus pour plus de dÃ©tails." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ’¬ Comment PR with build result
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const version = '${{ steps.version.outputs.version }}';
            const apkUrl = '${{ steps.wait_build.outputs.apk_url }}';
            
            let body = '## ğŸ“± Build APK Result\n\n';
            
            if (status === 'success') {
              body += '### âœ… Build rÃ©ussi!\n\n';
              body += `- **Version:** ${version}\n`;
              body += `- **Platform:** Android\n`;
              body += `- **Profile:** preview\n\n`;
              
              if (apkUrl) {
                body += `ğŸ“¥ **[TÃ©lÃ©charger l'APK](${apkUrl})**\n\n`;
              }
              
              body += 'ğŸ‰ L\'APK est Ã©galement disponible dans les artifacts de ce workflow.';
            } else {
              body += '### âŒ Build Ã©chouÃ©\n\n';
              body += 'Consultez les logs du workflow pour plus de dÃ©tails.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
