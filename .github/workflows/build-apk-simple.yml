name: Build APK (Simple)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    name: Build and Release APK
    runs-on: ubuntu-latest
    
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Install dependencies
        run: npm install

      - name: üîß Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üéØ Initialize EAS Project
        run: |
          # Create app.json with a unique project ID based on repo
          UNIQUE_ID=$(echo "$GITHUB_REPOSITORY" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
          
          # Update app.json with unique slug
          jq --arg slug "$UNIQUE_ID" '.expo.slug = $slug' app.json > app.json.tmp && mv app.json.tmp app.json
          
          # Try to create/link EAS project
          eas build:configure || true
          eas init --id || true
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: üèóÔ∏è Build APK with EAS
        run: |
          eas build --platform android --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: üì• Get build artifact URL
        id: get_url
        run: |
          # Get the latest build URL
          BUILD_URL=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].artifacts.buildUrl')
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          
          # Download the APK
          wget -O roleplay-chat-${{ github.event.inputs.version }}.apk "$BUILD_URL"

      - name: üè∑Ô∏è Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Roleplay Chat v${{ github.event.inputs.version }}
          body: |
            ## üéâ Roleplay Chat - Version ${{ github.event.inputs.version }}
            
            ### üì± Installation
            1. T√©l√©chargez `roleplay-chat-${{ github.event.inputs.version }}.apk`
            2. Installez sur votre Android
            3. Ajoutez vos cl√©s API Groq
            4. Profitez de 200 personnages !
            
            ### ‚ú® Nouveaut√©s
            - Application compl√®te de roleplay
            - 200 personnages diversifi√©s
            - Syst√®me RP immersif
            - G√©n√©ration d'images AI
            - Progression et relations
          files: |
            roleplay-chat-${{ github.event.inputs.version }}.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
